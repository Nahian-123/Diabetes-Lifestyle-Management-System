{% extends 'patient_base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 fw-bold">Welcome, {{ name }}</h1>
    <!--ANGSHU PART-->
    <!-- This div contains Bell and ID, INSERT HERE -->
    <!-- <div class="d-flex justify-content-end align-items-center" style="gap: 20px;"> -->
    <!-- Bell Icon Angshu -->
    <!-- <div style="position: relative;">
        <button id="notificationBell" class="btn btn-link position-relative">
            <i class="bi bi-bell" style="font-size: 1.8rem;"></i>
            {% if notifications %}
                <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    {{ notifications|length }}
                </span>
            {% endif %}
        </button> -->


    <!-- Dropdown Notifications Angshu -->
    <!--<div id="notificationDropdown" class="dropdown-menu text-black" style="display:none; max-height:300px; overflow:auto; background-color: #ccf5d3;"-->
    <!--    <div id="notificationDropdown" class="dropdown-menu" style="display: none; max-height: 300px; overflow: auto; background-color: #ccf5d3; right: 0; left: auto; position: absolute;">


            {% if notifications %}
                {% for note in notifications %}
                    <div class="dropdown-item d-flex justify-content-between align-items-center" data-notif-id="{{ note.id }}">
                        <div>{{ note.message }}</div>
                        <button class="btn-close ms-2" onclick="removeNotification(this)"></button>
                    </div>
                {% endfor %}
            {% else %}
                <div class="dropdown-item text-muted">No new notifications</div>
            {% endif %}
        </div> 
    </div> -->

    <div>
        <p class="text-center"><strong>Your ID: {{ p_id }}</strong></p>
    </div>
</div>

<!---->


<!-- <div><p class="text-center"><strong>Your ID: {{ p_id }}</strong></p></div>
</div> -->


<!-- Flash Message -->
{% with messages = get_flashed_messages() %}
{% if messages %}
<div class="alert alert-success text-center" role="alert">
    {% for message in messages %}
    <p class="mb-0">{{ message }}</p>
    {% endfor %}
</div>
<script>
    setTimeout(function () {
        window.location.href = "{{ url_for('patient_dashboard') }}";
    }, 5000);
</script>
{% endif %}
{% endwith %}


<!-- SOS Sent message-->
<!-- {% if request.args.get('alert') == 'sos_sent' %}
<div class="alert alert-success alert-dismissible fade show text-center fw-bold mt-3" role="alert">
        üö® SOS alert sent. Help is on the way!
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %} -->


<div class="card mb-3">
    <div class="card-body card-body-custom">
        <h4>How to use this website:</h4>
        <ul>
            <li>Update your profile from the "Update Profile" section.</li>
            <li>You need to fulfill your glucose level portion and the whole profile to make a
                successful appointment.</li>
            <li>Use glucometer to measure your glucose level 4 times before your appointment day.</li>
            <li>4 times: before breakfast, after breakfast, before lunch, before dinner</li>
            <li><a href="https://www.apollo247.com/blog/article/how-to-use-a-glucose-monitor">Step-by-step
                    guidance to use a glucometer</a></li>
        </ul>
    </div>
</div>


<!-- Glucose Levels Bar Chart -->
<div class="bar-chart-container">
    <div class="chart-wrapper">
        <canvas id="glucoseChart"></canvas>
    </div>


    <!--<div class="last-updated">
    Last Updated: {{ updated_on }}
</div> -->


    <!--ANGSHU PART-->
    <!-- Wrapping box with fixed styling -->
    <div class="update-message-container">
        <div class="last-updated">
            <strong> Glucose Level Last Updated:</strong> {{ updated_on }}
        </div>




        <div class="smbg-container mt-3">
            {% if smbg_status == "prescribed" %}
            <div class="smbg-details">
                <strong>Your SMBG Routine:</strong><br>
                Number of times to monitor per week: {{ weekly_smbg }} <br>
                Advised by: {{ doctor_name }} <br>
                Advised On: {{ smbg_date }}
            </div>


            {% else %}
            <div class="smbg-details">
                <strong>Your SMBG Routine:</strong> Not prescribed yet
            </div>
            {% endif %}
        </div>






        <!-- {% if medication_message %}
    <div class="medication-reminder mt-2">
        <strong>Medication Reminder</strong><br>
        {{ medication_message }}
    </div>
   
    {% endif %}-->
    </div>
    <!---->


</div>

<!--GRAPH , remove the comment out sign while running the project-->
<script>
    const ctx = document.getElementById('glucoseChart').getContext('2d');
    const glucoseChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ ['Before Breakfast', 'After Breakfast', 'Before Lunch', 'Before Dinner'] | safe }},
    datasets: [{
        label: 'Glucose Levels (mmol/L)',
        data: {{ glucose_data | tojson }},
        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
        borderColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
        borderWidth: 1,
        borderRadius: 4
        }]
    },



    options: {
        responsive: true,
            plugins: {
            legend: { position: 'top' },
            annotation: {
                annotations: {
                    healthyLine: {
                        type: 'line',
                            borderColor: 'green',
                                borderWidth: 2,
                                    scaleID: 'y',
                                        value: 7,
                                            label: {
                            content: 'Healthy Glucose Level (7 mmol/L)',
                                enabled: true,
                                    position: 'start',
                                        backgroundColor: 'rgba(0,128,0,0.7)',
                                            color: 'white'
                        }
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                    suggestedMax: 20,
                        ticks: {
                    stepSize: 2,
                        callback: function(value) {
                            return value + ' mmol/L';
                        }
                }
            }
        }
    }






});
</script>




<!-- live location-->


<!-- <script>
function triggerSOS() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition((position) => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
 
      fetch("/fire_sos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ latitude: lat, longitude: lon })
      }).then(() => {
        window.location.href = "/patient_dashboard?alert=sos_sent";
      });
 
    }, () => {
      alert("‚ùå Location access denied.");
    });
  } else {
    alert("Geolocation is not supported.");
  }
}
</script> -->


<!--ANGSHU -->
<!--new code angshu-->
<!-- <script>
    document.addEventListener('DOMContentLoaded', function() {
        var bell = document.getElementById('notificationBell');
        var dropdown = document.getElementById('notificationDropdown');
   
        bell.addEventListener('click', function(event) {
            event.stopPropagation();
            if (dropdown.style.display === "none" || dropdown.style.display === "") {
                dropdown.style.display = "block";
            } else {
                dropdown.style.display = "none";
            }
        });
   
        document.addEventListener('click', function(event) {
            if (!dropdown.contains(event.target) && !bell.contains(event.target)) {
                dropdown.style.display = "none";
            }
        });
    });
   
    // üÜï removeNotification function
    function removeNotification(button) {
        const notification = button.closest('.dropdown-item');
        if (notification) {
            const notifId = notification.getAttribute('data-notif-id');
            notification.remove();
   
            // Update counter
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                let count = parseInt(badge.textContent);
                if (!isNaN(count)) {
                    count--;
                    if (count > 0) {
                        badge.textContent = count;
                    } else {
                        badge.remove();
                    }
                }
            }
   
            // Send dismissal request
            fetch(`/dismiss_notification/${notifId}`, {
                method: 'POST'
            }).then(response => {
                if (!response.ok) {
                    console.error("Failed to dismiss notification.");
                }
            });
        }
    }
    </script> -->
{% endblock %}